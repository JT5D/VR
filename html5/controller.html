<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
    <title>Gamepad shtuff</title>
</head>
<body>
    <div id="output"></div>
    <script>
        function controllerTest() {
            var output = document.getElementById("output");
            var pad;

            function setPad(gamepad){
                if (gamepad && confirm(fmt("Use this gamepad? $1", gamepad.id))) {
                    pad = gamepad;
                    requestAnimationFrame(loop);
                    return true;
                }
                else {
                    return false;
                }
            }

            var frame = 0;

            function loop(dt) {
                requestAnimationFrame(loop);
                var buttonInfo = [];
                for (var i = 0; i < pad.buttons.length; ++i) {
                    if (pad.buttons[i].pressed) {
                        buttonInfo.push(i);
                    }
                }
                var axisInfo = [];
                for (var i = 0; i < pad.axes.length; ++i) {
                    axisInfo.push(fmt("[$1: $2.00]", i, pad.axes[i]));
                }
                output.innerHTML = fmt("frame: $3<br>buttons: $1<br>axes: $2",
                    buttonInfo.join(" -- "),
                    axisInfo.join(" -- "),
                    frame++);
            }

            window.addEventListener("gamepadconnected", function (event) {
                setPad(event.gamepad);
            }, false);

            window.addEventListener("gamepaddisconnected", function (event) {
                console.log("disconnected", event);
            }, false);


            function checkfer(){
                var pads = null;
                if (navigator.getGamepads) {
                    pads = navigator.getGamepads();
                }
                else if (navigator.webkitGetGamepads) {
                    pads = navigator.webkitGetGamepads();
                }
                var found = false;
                if (pads) {
                    for (var i = 0; i < pads.length && !found; ++i) {
                        found = setPad(pads[i]);
                    }
                }
                if (!found) {
                    setTimeout(checkfer, 1000);
                }
            }
            setTimeout(checkfer, 1000);
        }
        var curAppVersion = 1;
        var s = document.createElement("script");
        s.async = 1;
        s.addEventListener("load", function () {
            include(curAppVersion,
            function () { controllerTest(); },
            "js/psychologist.js");
        }, false);
        s.src = "js/include.js?v" + curAppVersion;
        document.body.appendChild(s);
    </script>
</body>
</html>